<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0" />
    <title>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø§Ù„ÙŠØ© | Ø´Ø±ÙƒØ© Ø­Ù„ÙˆÙ„ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>

    <!-- Ù…ÙƒØªØ¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Ù…ÙƒØªØ¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª PDF (pdf.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
    <script>
      // ØªØ¹Ø±ÙŠÙ Ù…Ø³Ø§Ø± Ø§Ù„Ù€ worker Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ pdf.js
      if (window["pdfjsLib"]) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js";
      }
    </script>

    <style>
      :root {
        --bg: #020617;
        --bg-soft: #020617;
        --bg-card: #020617;
        --bg-elevated: #020617;
        --border: #1f2937;
        --accent: #22c55e;
        --accent-soft: rgba(34, 197, 94, 0.12);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --danger: #f97373;
        --radius-card: 18px;
        --shadow-soft: 0 20px 40px rgba(0, 0, 0, 0.45);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #020617 0, #020617 45%, #020617 100%);
        color: var(--text);
        min-height: 100vh;
      }

      .page {
        max-width: 1100px;
        margin: 24px auto;
        padding: 16px;
      }

      .header {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 18px;
      }

      .header-title {
        font-size: 1.6rem;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      .header-sub {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .card {
        background: rgba(15, 23, 42, 0.95);
        border-radius: var(--radius-card);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-soft);
        padding: 16px 18px;
        margin-bottom: 16px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
      }

      .card-title {
        font-size: 1rem;
        font-weight: 600;
      }

      .badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--accent-soft);
        background: rgba(15, 118, 110, 0.08);
        color: var(--accent);
      }

      .input-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 8px;
      }

      .field {
        flex: 1 1 180px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      label {
        font-size: 0.78rem;
        color: var(--muted);
      }

      input[type="text"],
      input[type="date"],
      input[type="number"],
      input[type="file"] {
        padding: 7px 9px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #020617;
        color: var(--text);
        font-size: 0.85rem;
      }

      input[type="file"] {
        padding: 5px 4px;
      }

      input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      }

      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 8px 0 4px;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 7px 16px;
        font-size: 0.85rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.1s ease, box-shadow 0.1s ease,
          background 0.1s ease;
        white-space: nowrap;
      }

      .btn-primary {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #020617;
        box-shadow: 0 12px 30px rgba(34, 197, 94, 0.3);
      }

      .btn-secondary {
        background: rgba(15, 23, 42, 0.95);
        color: var(--text);
        border: 1px solid var(--border);
      }

      .btn-danger {
        background: rgba(248, 113, 113, 0.15);
        color: var(--danger);
        border: 1px solid rgba(248, 113, 113, 0.4);
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.6);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.7rem;
        padding: 3px 10px;
        border-radius: 999px;
        border: 1px dashed var(--border);
        color: var(--muted);
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
        margin-top: 6px;
      }

      .summary-card {
        border-radius: 14px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top left, #064e3b, #020617);
        padding: 8px 10px;
      }

      .summary-label {
        font-size: 0.7rem;
        color: var(--muted);
        margin-bottom: 2px;
      }

      .summary-value {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .summary-value.danger {
        color: var(--danger);
      }

      .summary-value.success {
        color: var(--accent);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 6px;
        font-size: 0.8rem;
      }

      thead {
        background: rgba(15, 23, 42, 0.95);
      }

      th,
      td {
        border: 1px solid #111827;
        padding: 6px 8px;
        text-align: center;
      }

      th {
        font-weight: 600;
        color: var(--muted);
      }

      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.9);
      }

      tbody tr:nth-child(odd) {
        background: rgba(15, 23, 42, 0.75);
      }

      .text-start {
        text-align: right;
      }

      .badge-tilad {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent);
      }

      .note {
        font-size: 0.75rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .section-title {
        font-weight: 600;
        margin-top: 8px;
        margin-bottom: 4px;
        font-size: 0.9rem;
      }

      .textarea-like {
        border-radius: 10px;
        border: 1px dashed var(--border);
        padding: 6px 9px;
        font-size: 0.78rem;
        color: var(--muted);
        min-height: 40px;
        white-space: pre-line;
      }

      @media (max-width: 700px) {
        .card {
          padding: 12px 10px;
        }

        .header-title {
          font-size: 1.2rem;
        }
      }

      /* Ù†Ù…Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ØªØµØ¯ÙŠØ± PDF Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ */
      @media print {
        body {
          background: #ffffff;
          color: #000000;
        }

        .page {
          margin: 0;
          max-width: 100%;
          padding: 0 16px 16px;
        }

        .card {
          box-shadow: none;
          border-radius: 0;
          border: none;
          background: #ffffff;
        }

        .btn-row,
        input[type="file"],
        .pill {
          display: none !important;
        }

        .header-sub {
          color: #222;
        }

        th,
        td {
          border-color: #888;
        }

        .summary-card {
          background: #f9fafb;
          border-color: #ddd;
        }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header class="header">
        <div class="header-title">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø§Ù„ÙŠØ© | Ø´Ø±ÙƒØ© Ø­Ù„ÙˆÙ„ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</div>
        <div class="header-sub">
          Ø£Ø¯Ø§Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ (PDF / Excel) Ø¨Ù†ÙØ³ Ù…Ù†Ù‡Ø¬ÙŠØ© ØªÙ‚Ø§Ø±ÙŠØ± Tilad Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©.
        </div>
      </header>

      <!-- Ù¡) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">Ù¡) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© ÙˆØ±ÙØ¹ ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
          <span class="badge">ÙˆØ­Ø¯Ø©: ØªØ·ÙˆÙŠØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ / Ø´Ø±ÙƒØ© Ø­Ù„ÙˆÙ„ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</span>
        </div>

        <div class="input-row">
          <div class="field">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</label>
            <input id="tenderNumber" type="text" placeholder="Ù…Ø«Ø§Ù„: 250739006702" />
          </div>

          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ / Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</label>
            <input
              id="tenderName"
              type="text"
              placeholder="Ù…Ø«Ø§Ù„: Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ø·Ø§Ø±ÙŠØ© Ù„ØªÙˆØ±ÙŠØ¯ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„ÙØ·Ø±ÙŠØ©..." />
          </div>

          <div class="field">
            <label>ØªØ§Ø±ÙŠØ® ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶</label>
            <input id="openDate" type="date" />
          </div>
        </div>

        <div class="input-row">
          <div class="field">
            <label>Ø§Ø³Ù… Ø´Ø±ÙƒØ© ØªÙ„Ø§Ø¯ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù„Ù„ØªØ¹Ø±Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
            <input
              id="tiladName"
              type="text"
              value="Ø§ï»Ÿï»£ïº—ï»›ïºï»£ï» ïº” ïº—ï»¼Ø¯ ïº£ï» ÙˆÙ„  ïº·Ø±ï»›ïº”"
              placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ PDF Ø§Ø¹ØªÙ…Ø§Ø¯" />
          </div>

          <div class="field">
            <label>Ø±ÙØ¹ Ù…Ù„Ù ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ (PDF / Excel / CSV)</label>
            <input id="fileInput" type="file" accept=".pdf,.xlsx,.xls,.csv" />
            <div class="note">
              ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø±ÙØ¹ <strong>Ù…Ù„Ù PDF Ù…Ø¨Ø§Ø´Ø±Ø©</strong> Ù…Ù† Ù…Ù†ØµØ© Ø§Ø¹ØªÙ…Ø§Ø¯ØŒ  
              Ø£Ùˆ Ù…Ù„Ù Excel / CSV Ø¥Ù† ØªÙˆÙØ±.
            </div>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn-primary" onclick="processFile()">
            ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¢Ù†
          </button>
          <button class="btn-secondary" onclick="clearAll()">
            ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          </button>
          <button class="btn-secondary" onclick="window.print()">
            ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ PDF (Ø·Ø¨Ø§Ø¹Ø© â†’ Ø­ÙØ¸ ÙƒÙ€ PDF)
          </button>
        </div>

        <div class="pill">
          â„¹ï¸ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:  
          1) ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Ø§Ø¹ØªÙ…Ø§Ø¯ (PDF ÙƒÙ…Ø§ Ù‡Ùˆ)  
          2) Ø±ÙØ¹Ù‡ Ù‡Ù†Ø§ â†’ 3) ÙŠØ¸Ù‡Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªÙˆØµÙŠØ© Ø¢Ù„ÙŠÙ‹Ø§
        </div>
      </section>

      <!-- Ù¢) Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
      <section class="card" id="summaryCard" style="display: none">
        <div class="card-header">
          <div class="card-title">Ù¢) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        </div>

        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</div>
            <div class="summary-value" id="sTenderNumber">â€”</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
            <div class="summary-value" id="sTenderName">â€”</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">ØªØ§Ø±ÙŠØ® ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
            <div class="summary-value" id="sOpenDate">â€”</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© Ù…Ø§Ù„ÙŠÙ‹Ø§</div>
            <div class="summary-value" id="sOffersCount">â€”</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Ø£Ù‚Ù„ Ø¹Ø±Ø¶ (Ø±ÙŠØ§Ù„)</div>
            <div class="summary-value success" id="sLowestBid">â€”</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ© Ø­Ù„ÙˆÙ„ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© (Ø±ÙŠØ§Ù„)</div>
            <div class="summary-value" id="sTiladBid">â€”</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">ØªØ±ØªÙŠØ¨ ØªÙ„Ø§Ø¯ Ù…Ø§Ù„ÙŠÙ‹Ø§</div>
            <div class="summary-value" id="sTiladRank">â€”</div>
          </div>

          <div class="summary-card">
            <div class="summary-label">Ù†Ø³Ø¨Ø© Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶</div>
            <div class="summary-value danger" id="sTiladVsLowest">â€”</div>
          </div>
        </div>
      </section>

      <!-- Ù£) Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ -->
      <section class="card" id="tableCard" style="display: none">
        <div class="card-header">
          <div class="card-title">Ù£) Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ø±ÙˆØ¶</div>
        </div>

        <div class="section-title">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†:</div>
        <table>
          <thead>
            <tr>
              <th>Ù…</th>
              <th class="text-start">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</th>
              <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ø±ÙŠØ§Ù„)</th>
              <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ (%)</th>
              <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ (%)</th>
            </tr>
          </thead>
          <tbody id="offersTableBody"></tbody>
        </table>

        <div class="note">
          * ÙŠØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØªØµØ§Ø¹Ø¯ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶.  
          * Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ = (Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶ Ã· Ø£Ù‚Ù„ Ø¹Ø±Ø¶).  
          * Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ = (Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶ Ã· Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯).
        </div>
      </section>

      <!-- Ù¤) Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ© -->
      <section class="card" id="notesCard" style="display: none">
        <div class="card-header">
          <div class="card-title">Ù¤) Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ© (Ù…Ø³ÙˆØ¯Ø©)</div>
        </div>

        <div class="section-title">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©:</div>
        <div id="generalNotes" class="textarea-like"></div>

        <div class="section-title">Ø§Ù„ØªÙˆØµÙŠØ©:</div>
        <div id="recommendation" class="textarea-like"></div>

        <div class="note">
          ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Word Ø£Ùˆ Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø© ÙƒÙ€ PDF.
        </div>
      </section>
    </div>

    <script>
      let parsedOffers = [];

      function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return "â€”";
        return num.toLocaleString("ar-SA", {
          maximumFractionDigits: 2,
        });
      }

      function formatPercent(num) {
        if (num === null || num === undefined || isNaN(num)) return "â€”";
        return (
          num.toLocaleString("ar-SA", {
            maximumFractionDigits: 2,
          }) + " %"
        );
      }

      function processFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
          alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø£ÙˆÙ„Ø§Ù‹ (PDF Ø£Ùˆ Excel).");
          return;
        }

        const name = file.name.toLowerCase();

        if (name.endsWith(".pdf")) {
          processPdfFile(file);
        } else {
          processExcelFile(file);
        }
      }

      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù PDF
      function processPdfFile(file) {
        if (!window["pdfjsLib"]) {
          alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© PDF Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
          return;
        }

        const reader = new FileReader();
        reader.onload = async function (e) {
          try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;

            let fullText = "";
            const numPages = pdf.numPages;

            for (let p = 1; p <= numPages; p++) {
              const page = await pdf.getPage(p);
              const content = await page.getTextContent();
              const strings = content.items.map((it) => it.str);
              fullText += strings.join(" ") + "\n";
            }

            parsedOffers = parseOffersFromPdfText(fullText);

            if (!parsedOffers || parsedOffers.length === 0) {
              alert(
                "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¹Ø±ÙˆØ¶ Ù…Ø§Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ù€ PDF.\nØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù‡Ùˆ ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Ù…Ù†ØµØ© Ø§Ø¹ØªÙ…Ø§Ø¯."
              );
              return;
            }

            runAnalysis();
          } catch (err) {
            console.error(err);
            alert(
              "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF.\nÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ù†Ø·Ù‚ Ø­Ø³Ø¨ Ø´ÙƒÙ„ ØªÙ‚Ø§Ø±ÙŠØ±ÙƒÙ…."
            );
          }
        };

        reader.readAsArrayBuffer(file);
      }

      // ØªØ­ÙˆÙŠÙ„ Ù†Øµ PDF Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø±ÙˆØ¶ (Ø§Ø³Ù… + Ù‚ÙŠÙ…Ø©)
      function parseOffersFromPdfText(text) {
        const offers = [];

        // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙ‚Ø§Ø·: [Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ] + [Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶] + [Ù‚ÙŠÙ…Ø© Ø¨ØµÙŠØºØ© 30060844.75]
        const regex =
          /([\u0600-\u06FF\s]+?)\s+(\d{6,})\s+(\d+\.\d{2})/g;

        let match;
        while ((match = regex.exec(text)) !== null) {
          let name = match[1] || "";
          const amountStr = match[3] || "";

          name = name.replace(/\s+/g, " ").trim();
          const amount = Number(amountStr.replace(/,/g, ""));

          if (!name || isNaN(amount)) continue;
          if (amount < 1000) continue; // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù…Ø¨Ø§Ù„Øº ØµØºÙŠØ±Ø© ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠØ©

          offers.push({
            name,
            value: amount,
          });
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± (Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… + Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ…Ø©)
        const unique = [];
        const seen = new Set();
        for (const o of offers) {
          const key = o.name + "|" + o.value;
          if (!seen.has(key)) {
            seen.add(key);
            unique.push(o);
          }
        }

        return unique;
      }

      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Excel / CSV
      function processExcelFile(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];

          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          if (!rows || rows.length === 0) {
            alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„.");
            return;
          }

          const headers = rows[0].map((h) => (h || "").toString().trim());
          const dataRows = rows.slice(1);

          let nameColIndex = -1;
          let valueColIndex = -1;

          headers.forEach((h, idx) => {
            const hNorm = h.replace(/\s+/g, "");
            if (
              nameColIndex === -1 &&
              (hNorm.includes("Ø§Ø³Ù…Ø§Ù„Ù…ÙˆØ±Ø¯") ||
                hNorm.includes("Ø§Ù„Ù…ÙˆØ±Ø¯") ||
                hNorm.includes("Ø§Ø³Ù…") ||
                hNorm.includes("Ø§Ù„Ù…ØªÙ†Ø§ÙØ³"))
            ) {
              nameColIndex = idx;
            }

            if (
              valueColIndex === -1 &&
              (hNorm.includes("Ù‚ÙŠÙ…Ø©Ø§Ù„Ø¹Ø±Ø¶") ||
                hNorm.includes("Ø§Ù„Ù…Ø¨Ù„Øº") ||
                hNorm.includes("Ø§Ù„Ù‚ÙŠÙ…Ø©") ||
                hNorm.includes("Value"))
            ) {
              valueColIndex = idx;
            }
          });

          if (nameColIndex === -1) nameColIndex = 0;
          if (valueColIndex === -1) valueColIndex = 1;

          const offers = [];

          dataRows.forEach((row) => {
            const name = (row[nameColIndex] || "").toString().trim();
            let valueRaw = row[valueColIndex];

            if (!name || name === "") return;
            if (valueRaw === null || valueRaw === undefined || valueRaw === "")
              return;

            if (typeof valueRaw === "string") {
              valueRaw = valueRaw.replace(/,/g, "").replace(/\s/g, "");
            }

            const value = Number(valueRaw);
            if (isNaN(value)) return;

            offers.push({
              name,
              value,
            });
          });

          if (offers.length === 0) {
            alert(
              "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø±ÙˆØ¶ ØµØ§Ù„Ø­Ø© (Ø§Ø³Ù… + Ù‚ÙŠÙ…Ø©). ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„."
            );
            return;
          }

          parsedOffers = offers;
          runAnalysis();
        };

        reader.readAsArrayBuffer(file);
      }

      function runAnalysis() {
        if (!parsedOffers || parsedOffers.length === 0) return;

        const offersSorted = [...parsedOffers].sort((a, b) => a.value - b.value);

        const lowest = offersSorted[0];

        const tiladNameInput = document
          .getElementById("tiladName")
          .value.trim();
        const tiladOffer =
          offersSorted.find((o) => o.name.includes(tiladNameInput)) ||
          offersSorted.find((o) => o.name.includes("ØªÙ„Ø§Ø¯")) ||
          null;

        const tenderNumber =
          document.getElementById("tenderNumber").value.trim() || "â€”";
        const tenderName =
          document.getElementById("tenderName").value.trim() || "â€”";
        const openDateRaw = document.getElementById("openDate").value;
        const openDate = openDateRaw
          ? new Date(openDateRaw).toLocaleDateString("ar-SA")
          : "â€”";

        document.getElementById("sTenderNumber").textContent = tenderNumber;
        document.getElementById("sTenderName").textContent = tenderName;
        document.getElementById("sOpenDate").textContent = openDate;
        document.getElementById("sOffersCount").textContent =
          offersSorted.length;

        let tiladBidValue = null;
        let tiladRank = "â€”";
        let tiladVsLowest = "â€”";

        if (tiladOffer) {
          tiladBidValue = tiladOffer.value;
          const rankIndex =
            offersSorted.findIndex((o) => o === tiladOffer) + 1;
          tiladRank = rankIndex + " Ù…Ù† " + offersSorted.length;

          const diff = tiladOffer.value - lowest.value;
          const pct = (diff / lowest.value) * 100;
          tiladVsLowest =
            (pct >= 0 ? "+" : "") +
            pct.toLocaleString("ar-SA", { maximumFractionDigits: 2 }) +
            " %";
        } else {
          tiladVsLowest =
            "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ ÙŠØ­Ù…Ù„ Ø§Ø³Ù… ØªÙ„Ø§Ø¯ ÙÙŠ Ø§Ù„Ù…Ù„ÙØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù‚Ù„ (Ø§Ø³Ù… Ø´Ø±ÙƒØ© ØªÙ„Ø§Ø¯ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±).";
        }

        document.getElementById("sTiladBid").textContent = tiladBidValue
          ? formatNumber(tiladBidValue)
          : "â€”";
        document.getElementById("sTiladRank").textContent = tiladRank;
        document.getElementById("sTiladVsLowest").textContent = tiladVsLowest;
        document.getElementById("sLowestBid").textContent = formatNumber(
          lowest.value
        );

        const tbody = document.getElementById("offersTableBody");
        tbody.innerHTML = "";

        offersSorted.forEach((offer, idx) => {
          const tr = document.createElement("tr");

          const isTilad = tiladOffer && offer === tiladOffer;

          const tdIndex = document.createElement("td");
          tdIndex.textContent = idx + 1;

          const tdName = document.createElement("td");
          tdName.className = "text-start";
          tdName.textContent = offer.name;
          if (isTilad) {
            const badge = document.createElement("span");
            badge.className = "badge-tilad";
            badge.textContent = "ØªÙ„Ø§Ø¯";
            tdName.appendChild(document.createTextNode(" "));
            tdName.appendChild(badge);
          }

          const tdValue = document.createElement("td");
          tdValue.textContent = formatNumber(offer.value);

          const tdVsLowest = document.createElement("td");
          const pctLowest = (offer.value / lowest.value) * 100;
          tdVsLowest.textContent = formatPercent(pctLowest);

          const tdVsTilad = document.createElement("td");
          if (tiladOffer && tiladOffer.value > 0) {
            const pctTilad = (offer.value / tiladOffer.value) * 100;
            tdVsTilad.textContent = formatPercent(pctTilad);
          } else {
            tdVsTilad.textContent = "â€”";
          }

          tr.appendChild(tdIndex);
          tr.appendChild(tdName);
          tr.appendChild(tdValue);
          tr.appendChild(tdVsLowest);
          tr.appendChild(tdVsTilad);

          tbody.appendChild(tr);
        });

        const notes = [];
        notes.push(
          `â€¢ Ø¨Ù„Øº Ø£Ù‚Ù„ Ø¹Ø±Ø¶ Ù…Ù‚Ø¯Ù‘Ù… Ù…Ù† Ù‚Ø¨Ù„: "${lowest.name}" Ø¨Ù‚ÙŠÙ…Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù…Ù‚Ø¯Ø§Ø±Ù‡Ø§ ${formatNumber(
            lowest.value
          )} Ø±ÙŠØ§Ù„.`
        );

        if (tiladOffer) {
          const diffAbs = tiladOffer.value - lowest.value;
          const diffPct = (diffAbs / lowest.value) * 100;
          notes.push(
            `â€¢ Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ© Ø­Ù„ÙˆÙ„ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© Ø¨Ù„Øº Ø­ÙˆØ§Ù„ÙŠ ${formatNumber(
              tiladOffer.value
            )} Ø±ÙŠØ§Ù„ØŒ Ø£ÙŠ Ø¨Ø²ÙŠØ§Ø¯Ø© ØªÙ‚Ø§Ø±Ø¨ ${formatPercent(
              diffPct
            )} Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ Ù…Ø§Ù„ÙŠ.`
          );

          if (diffPct > 100) {
            notes.push(
              "â€¢ Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ ØªØªØ¬Ø§ÙˆØ² 100%ØŒ Ù…Ø§ Ù‚Ø¯ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆÙŠØªØ·Ù„Ù‘Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© ØªÙØµÙŠÙ„ÙŠØ© Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ³Ø¹ÙŠØ±ÙŠØ©."
            );
          } else if (diffPct > 40) {
            notes.push(
              "â€¢ Ù†Ø³Ø¨Ø© Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ ØªÙ‚Ø¹ ÙÙŠ Ù†Ø·Ø§Ù‚ Ù…ØªÙˆØ³Ø·/Ù…Ø±ØªÙØ¹ØŒ ÙˆÙŠØ³ØªØ­Ø³Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø°Ø§Øª Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ø£ÙƒØ¨Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙØ©."
            );
          } else {
            notes.push(
              "â€¢ Ù†Ø³Ø¨Ø© Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ ØªÙ‚Ø¹ Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ù…Ù‚Ø¨ÙˆÙ„ Ù†Ø³Ø¨ÙŠÙ‹Ø§ØŒ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ­Ø³ÙŠÙ† Ø¨Ø¹Ø¶ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø£ÙƒØ«Ø± ØªÙ†Ø§ÙØ³ÙŠØ©."
            );
          }
        } else {
          notes.push(
            "â€¢ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù‘Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ© Ø­Ù„ÙˆÙ„ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©ØŒ ÙŠÙØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ù‹Ø§."
          );
        }

        document.getElementById("generalNotes").textContent = notes.join("\n");

        let rec =
          "Ø§Ø³ØªÙ†Ø§Ø¯Ù‹Ø§ Ø¥Ù„Ù‰ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙÙ‚Ø·ØŒ ÙŠÙÙˆØµÙ‰ Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:\n\n";
        rec +=
          "1) Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ© Ø­Ù„ÙˆÙ„ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙØ±Øµ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°.\n";
        rec +=
          "2) ÙÙŠ Ø­Ø§Ù„ Ø«Ø¨ÙˆØª ÙˆØ¬ÙˆØ¯ ÙØ¬ÙˆØ© ÙƒØ¨ÙŠØ±Ø© ÙˆØºÙŠØ± Ù…Ø¨Ø±Ø±Ø© Ù…Ø¹ Ø£Ù‚Ù„ Ø¹Ø±Ø¶ Ù…Ø§Ù„ÙŠØŒ ÙŠÙÙ‚ØªØ±Ø­ Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø¨Ø¯ÙŠÙ„ Ù„Ø®ÙØ¶ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­.\n";
        rec +=
          "3) Ø§Ù„Ø£Ø®Ø° ÙÙŠ Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙÙ†ÙŠØŒ ÙˆØ§Ù„Ø³Ø¬Ù„Ù‘ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØŒ ÙˆÙ…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ©ØŒ Ù‚Ø¨Ù„ Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡Ø©.";

        document.getElementById("recommendation").textContent = rec;

        document.getElementById("summaryCard").style.display = "block";
        document.getElementById("tableCard").style.display = "block";
        document.getElementById("notesCard").style.display = "block";
      }

      function clearAll() {
        parsedOffers = [];
        document.getElementById("tenderNumber").value = "";
        document.getElementById("tenderName").value = "";
        document.getElementById("openDate").value = "";
        document.getElementById("fileInput").value = "";

        document.getElementById("summaryCard").style.display = "none";
        document.getElementById("tableCard").style.display = "none";
        document.getElementById("notesCard").style.display = "none";
      }
    </script>
  </body>
</html>
