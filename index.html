<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø§Ù„ÙŠØ© | Ø´Ø±ÙƒØ© ØªÙ„Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¨Ø¶Ø©</title>

  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --radius-card: 18px;
      --shadow-soft: 0 20px 40px rgba(0, 0, 0, 0.45);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 45%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 24px auto;
      padding: 16px;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 18px;
    }

    .header-title {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .header-sub {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
      margin-bottom: 16px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: rgba(15, 118, 110, 0.08);
      color: var(--accent);
    }

    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field {
      flex: 1 1 220px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.78rem;
      color: var(--muted);
    }

    input[type="file"] {
      padding: 5px 4px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 0.85rem;
    }

    input[type="file"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #020617;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.3);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      border: 1px solid var(--border);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.6);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      color: var(--muted);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    .summary-card {
      border-radius: 14px;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, #064e3b, #020617);
      padding: 8px 10px;
    }

    .summary-label {
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .summary-value {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .summary-value.danger { color: var(--danger); }
    .summary-value.success { color: var(--accent); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 0.8rem;
    }

    thead { background: rgba(15, 23, 42, 0.95); }

    th, td {
      border: 1px solid #111827;
      padding: 6px 8px;
      text-align: center;
    }

    th {
      font-weight: 600;
      color: var(--muted);
    }

    tbody tr:nth-child(even) { background: rgba(15, 23, 42, 0.9); }
    tbody tr:nth-child(odd)  { background: rgba(15, 23, 42, 0.75); }

    .text-start { text-align: right; }

    .badge-tilad {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .note {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .section-title {
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .textarea-like {
      border-radius: 10px;
      border: 1px dashed var(--border);
      padding: 6px 9px;
      font-size: 0.78rem;
      color: var(--muted);
      min-height: 40px;
      white-space: pre-line;
    }

    .signature {
      margin-top: 18px;
      font-size: 0.8rem;
      color: var(--muted);
      text-align: left;
      direction: ltr;
    }

    .signature span {
      direction: rtl;
      unicode-bidi: embed;
    }

    @media (max-width: 700px) {
      .card { padding: 12px 10px; }
      .header-title { font-size: 1.2rem; }
    }

    @media print {
      body {
        background: #ffffff;
        color: #000000;
      }

      .page {
        margin: 0;
        max-width: 100%;
        padding: 0 16px 16px;
      }

      .card {
        box-shadow: none;
        border-radius: 0;
        border: none;
        background: #ffffff;
      }

      .btn-row,
      input[type="file"],
      .pill {
        display: none !important;
      }

      .header-sub { color: #222; }

      th, td { border-color: #888; }

      .summary-card {
        background: #f9fafb;
        border-color: #ddd;
      }

      .signature { color: #222; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header class="header">
      <div class="header-title">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø§Ù„ÙŠØ© | Ø´Ø±ÙƒØ© Ø­Ù„ÙˆÙ„ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</div>
      <div class="header-sub">
        Ø£Ø¯Ø§Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ØªÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Ù…Ù†ØµØ© Ø§Ø¹ØªÙ…Ø§Ø¯ (Ù…Ù„Ù DOC) ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…Ø¯Ø®Ù„Ø§Øª ÙŠØ¯ÙˆÙŠØ©.
      </div>
    </header>

    <!-- Ù¡) Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">Ù¡) Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ (Ù…Ù„Ù DOC Ù…Ù† Ø§Ø¹ØªÙ…Ø§Ø¯)</div>
        <span class="badge">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³Ø§Øª / ØªÙ„Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¨Ø¶Ø©</span>
      </div>

      <div class="input-row">
        <div class="field">
          <label>Ù…Ù„Ù ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ (ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ù† Ù…Ù†ØµØ© Ø§Ø¹ØªÙ…Ø§Ø¯)</label>
          <input id="fileInput" type="file" accept=".doc,.html,.htm" />
          <div class="note">
            Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù† Ø§Ø¹ØªÙ…Ø§Ø¯ ØªÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© <strong>HTML</strong> Ù„ÙƒÙ†Ù‡Ø§ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø§Ù…ØªØ¯Ø§Ø¯ <strong>.DOC</strong> â€“  
            Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© ØªÙ‚Ø±Ø£Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØªØ³ØªØ®Ø±Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" onclick="processDoc()">
          ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¢Ù†
        </button>
        <button class="btn-secondary" onclick="window.print()">
          ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ PDF (Ø·Ø¨Ø§Ø¹Ø© â†’ Ø­ÙØ¸ ÙƒÙ€ PDF)
        </button>
      </div>

      <div class="pill">
        â„¹ï¸ Ø§Ù„Ø®Ø·ÙˆØ§Øª: 1) Ø­Ù…Ù‘Ù„ ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù…Ù† Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨ØµÙŠØºØ© DOC 2) Ø§Ø±ÙØ¹Ù‡ Ù‡Ù†Ø§ 3) ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
      </div>
    </section>

    <!-- Ù¢) Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <section class="card" id="summaryCard" style="display:none;">
      <div class="card-header">
        <div class="card-title">Ù¢) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      </div>

      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</div>
          <div class="summary-value" id="sTenderNumber">â€”</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ / Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</div>
          <div class="summary-value" id="sTenderName">â€”</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">ØªØ§Ø±ÙŠØ® ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
          <div class="summary-value" id="sOpenDate">â€”</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>
          <div class="summary-value" id="sOffersCount">â€”</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Ø£Ù‚Ù„ Ø¹Ø±Ø¶ (Ø±ÙŠØ§Ù„)</div>
          <div class="summary-value success" id="sLowestBid">â€”</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ (Ø±ÙŠØ§Ù„)</div>
          <div class="summary-value" id="sTiladBid">â€”</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">ØªØ±ØªÙŠØ¨ ØªÙ„Ø§Ø¯ Ù…Ø§Ù„ÙŠÙ‹Ø§</div>
          <div class="summary-value" id="sTiladRank">â€”</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Ù†Ø³Ø¨Ø© Ø²ÙŠØ§Ø¯Ø© ØªÙ„Ø§Ø¯ Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶</div>
          <div class="summary-value danger" id="sTiladVsLowest">â€”</div>
        </div>
      </div>
    </section>

    <!-- Ù£) Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ -->
    <section class="card" id="tableCard" style="display:none;">
      <div class="card-header">
        <div class="card-title">Ù£) Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ø±ÙˆØ¶</div>
      </div>

      <div class="section-title">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†:</div>
      <table>
        <thead>
          <tr>
            <th>Ù…</th>
            <th class="text-start">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯</th>
            <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ø±ÙŠØ§Ù„)</th>
            <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ (%)</th>
            <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ (%)</th>
          </tr>
        </thead>
        <tbody id="offersTableBody"></tbody>
      </table>

      <div class="note" id="tableNote">
        * ÙŠØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØªØµØ§Ø¹Ø¯ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶ØŒ Ù…Ø¹ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ "ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ ÙÙ†ÙŠØ§Ù‹".
      </div>
    </section>

    <!-- Ù¤) Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ© -->
    <section class="card" id="notesCard" style="display:none;">
      <div class="card-header">
        <div class="card-title">Ù¤) Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªÙˆØµÙŠØ© (Ù…Ø³ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)</div>
      </div>

      <div class="section-title">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©:</div>
      <div id="generalNotes" class="textarea-like"></div>

      <div class="section-title">Ø§Ù„ØªÙˆØµÙŠØ©:</div>
      <div id="recommendation" class="textarea-like"></div>

      <div class="note">
        ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø¨Ø¹Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Word Ø£Ùˆ PDF Ø­Ø³Ø¨ ÙƒÙ„ Ù…Ù†Ø§ÙØ³Ø©.
      </div>
    </section>

    <!-- ØªÙˆÙ‚ÙŠØ¹ -->
    <div class="signature">
      <span>Ø¥Ø¹Ø¯Ø§Ø¯: Ø¯. Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† ÙØ§Ø¦Ù‚ Ø³Ø±Ø³Ùƒ</span> | Dr. Abdulrahman Fayeq Sarsak
    </div>
  </div>

  <script>
    let parsedOffers = [];
    let onlySuppliers = [];
    let meta = { tenderNumber: "â€”", tenderName: "â€”", openDate: "â€”" };

    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return "â€”";
      return num.toLocaleString("ar-SA", { maximumFractionDigits: 2 });
    }

    function formatPercent(num) {
      if (num === null || num === undefined || isNaN(num)) return "â€”";
      return num.toLocaleString("ar-SA", { maximumFractionDigits: 2 }) + " %";
    }

    function processDoc() {
      const input = document.getElementById("fileInput");
      const file = input.files[0];

      if (!file) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ (DOC) Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        analyzeHtml(text);
      };
      reader.readAsText(file, "utf-8");
    }

    function analyzeHtml(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      parsedOffers = [];
      onlySuppliers = [];
      meta = parseMetaFromDoc(doc);

      const table = doc.querySelector('table[aria-label="offer details"]');
      if (!table) {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
        return;
      }

      const rows = Array.from(table.querySelectorAll("tr"));
      if (rows.length <= 1) {
        alert("Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.");
        return;
      }

      const headerCells = Array.from(rows[0].querySelectorAll("th,td"));
      const hasValueCol = headerCells.some((th) =>
        th.textContent.includes("Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶")
      );

      if (hasValueCol) {
        // ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø¹Ø±ÙˆØ¶ Ù…Ø§Ù„ÙŠØ©
        for (let i = 1; i < rows.length; i++) {
          const cells = rows[i].querySelectorAll("td");
          if (cells.length < 4) continue;

          const name = cells[0].textContent.trim();
          const offerNo = cells[1].textContent.trim();
          const valueText = cells[2].textContent.trim();
          const noteText = cells[3].textContent.trim();

          if (!name) continue;
          if (valueText.includes("ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚") || noteText.includes("ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚")) continue;

          const numericStr = valueText.replace(/,/g, "").trim();
          const value = Number(numericStr);
          if (isNaN(value) || value < 1000) continue;

          parsedOffers.push({ name, offerNo, value, note: noteText });
        }
      } else {
        // ØªÙ‚Ø±ÙŠØ± Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙ… Ù…Ø§Ù„ÙŠØ© (ÙÙ‚Ø· Ø£Ø³Ù…Ø§Ø¡ + Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±ÙˆØ¶)
        for (let i = 1; i < rows.length; i++) {
          const cells = rows[i].querySelectorAll("td");
          if (cells.length === 0) continue;
          const name = cells[0].textContent.trim();
          const offerNo = cells[1] ? cells[1].textContent.trim() : "";
          const noteText = cells[2] ? cells[2].textContent.trim() : "";
          if (!name) continue;
          onlySuppliers.push({ name, offerNo, note: noteText });
        }
      }

      if (parsedOffers.length === 0 && onlySuppliers.length === 0) {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†Ø§ÙØ³ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
        return;
      }

      runAnalysis();
    }

    function parseMetaFromDoc(doc) {
      const out = { tenderNumber: "â€”", tenderName: "â€”", openDate: "â€”" };
      const h6s = Array.from(doc.querySelectorAll("h6"));

      h6s.forEach((h) => {
        const t = h.textContent.trim();
        if (t.includes("Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©") && out.tenderNumber === "â€”") {
          const m = t.match(/\d+/);
          if (m) out.tenderNumber = m[0];
        } else if (
          (t.includes("ØªØ§Ø±ÙŠØ® ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶") || t.includes("ØªØ§Ø±ÙŠØ® ÙØªØ­")) &&
          out.openDate === "â€”"
        ) {
          const parts = t.split(":", 2);
          if (parts.length === 2 && parts[1].trim()) {
            out.openDate = parts[1].trim();
          }
        } else if (
          out.tenderName === "â€”" &&
          !t.includes("Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©") &&
          !t.includes("ØªØ§Ø±ÙŠØ®") &&
          !t.includes("ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶")
        ) {
          out.tenderName = t;
        }
      });

      return out;
    }

    function runAnalysis() {
      const summaryCard = document.getElementById("summaryCard");
      const tableCard = document.getElementById("tableCard");
      const notesCard = document.getElementById("notesCard");
      const tableBody = document.getElementById("offersTableBody");
      const tableNote = document.getElementById("tableNote");

      document.getElementById("sTenderNumber").textContent = meta.tenderNumber;
      document.getElementById("sTenderName").textContent = meta.tenderName;
      document.getElementById("sOpenDate").textContent = meta.openDate;

      tableBody.innerHTML = "";

      if (parsedOffers.length > 0) {
        // Ù„Ø¯ÙŠÙ†Ø§ Ù‚ÙŠÙ… Ø¹Ø±ÙˆØ¶ Ù…Ø§Ù„ÙŠØ©
        const offersSorted = [...parsedOffers].sort((a, b) => a.value - b.value);
        const lowest = offersSorted[0];
        const tiladOffer =
          offersSorted.find((o) => o.name.includes("ØªÙ„Ø§Ø¯")) || null;

        document.getElementById("sOffersCount").textContent =
          offersSorted.length.toString();
        document.getElementById("sLowestBid").textContent = formatNumber(
          lowest.value
        );

        let tiladBidValue = null;
        let tiladRankText = "â€”";
        let tiladVsLowestText = "â€”";

        if (tiladOffer) {
          tiladBidValue = tiladOffer.value;
          const rankIndex = offersSorted.indexOf(tiladOffer) + 1;
          tiladRankText = rankIndex + " Ù…Ù† " + offersSorted.length;

          const diff = tiladOffer.value - lowest.value;
          const pct = (diff / lowest.value) * 100;
          tiladVsLowestText =
            (pct >= 0 ? "+" : "") + pct.toLocaleString("ar-SA", { maximumFractionDigits: 2 }) + " %";
        } else {
          tiladVsLowestText = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ ÙŠØ­Ù…Ù„ Ø§Ø³Ù… (ØªÙ„Ø§Ø¯) ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.";
        }

        document.getElementById("sTiladBid").textContent = tiladBidValue
          ? formatNumber(tiladBidValue)
          : "â€”";
        document.getElementById("sTiladRank").textContent = tiladRankText;
        document.getElementById("sTiladVsLowest").textContent = tiladVsLowestText;

        offersSorted.forEach((offer, idx) => {
          const tr = document.createElement("tr");
          const isTilad = tiladOffer && offer === tiladOffer;

          const tdIndex = document.createElement("td");
          tdIndex.textContent = idx + 1;

          const tdName = document.createElement("td");
          tdName.className = "text-start";
          tdName.textContent = offer.name;
          if (isTilad) {
            const badge = document.createElement("span");
            badge.className = "badge-tilad";
            badge.textContent = "ØªÙ„Ø§Ø¯";
            tdName.appendChild(document.createTextNode(" "));
            tdName.appendChild(badge);
          }

          const tdValue = document.createElement("td");
          tdValue.textContent = formatNumber(offer.value);

          const tdVsLowest = document.createElement("td");
          const pctLowest = (offer.value / lowest.value) * 100;
          tdVsLowest.textContent = formatPercent(pctLowest);

          const tdVsTilad = document.createElement("td");
          if (tiladOffer && tiladOffer.value > 0) {
            const pctTilad = (offer.value / tiladOffer.value) * 100;
            tdVsTilad.textContent = formatPercent(pctTilad);
          } else {
            tdVsTilad.textContent = "â€”";
          }

          tr.appendChild(tdIndex);
          tr.appendChild(tdName);
          tr.appendChild(tdValue);
          tr.appendChild(tdVsLowest);
          tr.appendChild(tdVsTilad);
          tableBody.appendChild(tr);
        });

        tableNote.textContent =
          "* ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ (ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ ÙÙ†ÙŠØ§Ù‹) Ù…Ù† Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØŒ ÙˆØªÙ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±ÙˆØ¶ ØªØµØ§Ø¹Ø¯ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø±Ø¶.";

        // Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØªÙˆØµÙŠØ©
        const notes = [];
        notes.push(
          `â€¢ Ø¨Ù„Øº Ø£Ù‚Ù„ Ø¹Ø±Ø¶ Ù…Ù‚Ø¯Ù‘Ù… Ù…Ù† Ù‚Ø¨Ù„: "${lowest.name}" Ø¨Ù‚ÙŠÙ…Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù…Ù‚Ø¯Ø§Ø±Ù‡Ø§ ${formatNumber(
            lowest.value
          )} Ø±ÙŠØ§Ù„.`
        );

        if (tiladOffer) {
          const diffAbs = tiladOffer.value - lowest.value;
          const diffPct = (diffAbs / lowest.value) * 100;
          notes.push(
            `â€¢ Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ© ØªÙ„Ø§Ø¯ Ø¨Ù„Øº Ø­ÙˆØ§Ù„ÙŠ ${formatNumber(
              tiladOffer.value
            )} Ø±ÙŠØ§Ù„ØŒ Ø£ÙŠ Ø¨Ø²ÙŠØ§Ø¯Ø© ØªÙ‚Ø§Ø±Ø¨ ${formatPercent(
              diffPct
            )} Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ Ù…Ø§Ù„ÙŠØŒ Ù…Ø¹ ØªØ±ØªÙŠØ¨ Ù…Ø§Ù„ÙŠ ØªÙ‚Ø¯ÙŠØ±ÙŠ: ${tiladRankText}.`
          );

          if (diffPct > 100) {
            notes.push(
              "â€¢ Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ ØªØªØ¬Ø§ÙˆØ² 100%ØŒ Ù…Ø§ Ù‚Ø¯ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆÙŠØªØ·Ù„Ù‘Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© ØªÙØµÙŠÙ„ÙŠØ© Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ³Ø¹ÙŠØ±ÙŠØ©."
            );
          } else if (diffPct > 40) {
            notes.push(
              "â€¢ Ù†Ø³Ø¨Ø© Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ ØªÙ‚Ø¹ ÙÙŠ Ù†Ø·Ø§Ù‚ Ù…ØªÙˆØ³Ø·/Ù…Ø±ØªÙØ¹ØŒ ÙˆÙŠØ³ØªØ­Ø³Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø°Ø§Øª Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ø£ÙƒØ¨Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙØ©."
            );
          } else {
            notes.push(
              "â€¢ Ù†Ø³Ø¨Ø© Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ ØªÙ„Ø§Ø¯ Ø¹Ù† Ø£Ù‚Ù„ Ø¹Ø±Ø¶ ØªÙ‚Ø¹ Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ù…Ù‚Ø¨ÙˆÙ„ Ù†Ø³Ø¨ÙŠÙ‹Ø§ØŒ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ­Ø³ÙŠÙ† Ø¨Ø¹Ø¶ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø£ÙƒØ«Ø± ØªÙ†Ø§ÙØ³ÙŠØ©."
            );
          }
        } else {
          notes.push(
            "â€¢ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù‘Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ø³Ù… (ØªÙ„Ø§Ø¯)ØŒ ÙŠÙØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…ØªØ¹Ø§Ø±Ù Ø¹Ù„ÙŠÙ‡."
          );
        }

        document.getElementById("generalNotes").textContent = notes.join("\n");

        let rec =
          "Ø§Ø³ØªÙ†Ø§Ø¯Ù‹Ø§ Ø¥Ù„Ù‰ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙÙ‚Ø·ØŒ ÙŠÙÙˆØµÙ‰ Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:\n\n";
        rec +=
          "1) Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ© ØªÙ„Ø§Ø¯ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙØ±Øµ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°.\n";
        rec +=
          "2) ÙÙŠ Ø­Ø§Ù„ Ø«Ø¨ÙˆØª ÙØ¬ÙˆØ© Ù…Ø§Ù„ÙŠØ© ÙƒØ¨ÙŠØ±Ø© ÙˆØºÙŠØ± Ù…Ø¨Ø±Ø±Ø© Ù…Ø¹ Ø£Ù‚Ù„ Ø¹Ø±Ø¶ØŒ ÙŠÙÙ‚ØªØ±Ø­ Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø®ÙØ¶ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­.\n";
        rec +=
          "3) Ø±Ø¨Ø· Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙÙ†ÙŠØ© ÙˆÙ…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ© Ù‚Ø¨Ù„ Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø´Ø£Ù† Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡Ø©.";

        document.getElementById("recommendation").textContent = rec;
      } else {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ… Ø¹Ø±ÙˆØ¶ (Ù…Ø«Ù„ Ù…Ù„Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¢ÙØ§Øª)
        document.getElementById("sOffersCount").textContent =
          onlySuppliers.length.toString();
        document.getElementById("sLowestBid").textContent = "â€”";
        document.getElementById("sTiladBid").textContent = "â€”";
        document.getElementById("sTiladRank").textContent = "â€”";
        document.getElementById("sTiladVsLowest").textContent = "â€”";

        onlySuppliers.forEach((sup, idx) => {
          const tr = document.createElement("tr");
          const tdIndex = document.createElement("td");
          tdIndex.textContent = idx + 1;

          const tdName = document.createElement("td");
          tdName.className = "text-start";
          tdName.textContent = sup.name;
          if (sup.name.includes("ØªÙ„Ø§Ø¯")) {
            const badge = document.createElement("span");
            badge.className = "badge-tilad";
            badge.textContent = "ØªÙ„Ø§Ø¯";
            tdName.appendChild(document.createTextNode(" "));
            tdName.appendChild(badge);
          }

          const tdValue = document.createElement("td");
          tdValue.textContent = "â€”";

          const tdVsLowest = document.createElement("td");
          tdVsLowest.textContent = "â€”";

          const tdVsTilad = document.createElement("td");
          tdVsTilad.textContent = "â€”";

          tr.appendChild(tdIndex);
          tr.appendChild(tdName);
          tr.appendChild(tdValue);
          tr.appendChild(tdVsLowest);
          tr.appendChild(tdVsTilad);
          tableBody.appendChild(tr);
        });

        tableNote.textContent =
          "* Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ… Ø¹Ø±ÙˆØ¶ Ù…Ø§Ù„ÙŠØ©ØŒ ÙˆØ¥Ù†Ù…Ø§ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ£Ø±Ù‚Ø§Ù… Ø¹Ø±ÙˆØ¶Ù‡Ù… ÙÙ‚Ø·ØŒ Ù„Ø°Ù„Ùƒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¬Ø±Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ù„ÙŠ ØªÙØµÙŠÙ„ÙŠ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©.";

        const notes = [];
        notes.push(
          "â€¢ ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØªØ¶Ù…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯ÙˆÙ† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŒ ÙˆØ¹Ù„ÙŠÙ‡ ÙØ¥Ù† ØªØ±ØªÙŠØ¨ ØªÙ„Ø§Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„ÙØ±Ù‚ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ù„Ø§ØµÙ‡Ù…Ø§ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±."
        );
        notes.push(
          "â€¢ ÙŠÙÙˆØµÙ‰ Ø¨Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù„Ø§Ø­Ù‚Ø© Ø£Ùˆ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ØªØ±Ø³ÙŠØ© ÙÙŠ Ù…Ù†ØµØ© Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø¹Ø¯ Ø¥ØªØ§Ø­Ø© Ù‚ÙŠÙ… Ø§Ù„Ø¹Ø±ÙˆØ¶."
        );

        document.getElementById("generalNotes").textContent = notes.join("\n");

        let rec =
          "Ù†Ø¸Ø±Ù‹Ø§ Ù„Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø¹Ø±ÙˆØ¶ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ ÙŠÙ‚ØªØµØ± Ø¯ÙˆØ± Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ø¹Ù„Ù‰ ØªÙˆØ«ÙŠÙ‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªÙ†Ø§ÙØ³ÙŠÙ† ÙˆØ£Ø±Ù‚Ø§Ù… Ø¹Ø±ÙˆØ¶Ù‡Ù….\n\n";
        rec +=
          "â€¢ ÙŠÙÙˆØµÙ‰ Ø¨Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø£Ø±Ø´ÙØ© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙÙˆØ± ØªÙˆÙØ± ØªÙ‚Ø±ÙŠØ± ÙØªØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø£Ùˆ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ±Ø³ÙŠØ©.\n";

        document.getElementById("recommendation").textContent = rec;
      }

      summaryCard.style.display = "block";
      tableCard.style.display = "block";
      notesCard.style.display = "block";
    }
  </script>
</body>
</html>
